# ========================================================
# DEBUG PIPELINE - Shows Exact Stage Status
# ========================================================

trigger:
  branches:
    include:
      - master
      - main

variables:
  - group: Deployment-Secrets

stages:
# ================================
# STAGE 1: Build
# ================================
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    pool:
      name: 'Default'
    steps:
    - task: PowerShell@2
      displayName: 'Show Build Info'
      inputs:
        targetType: inline
        script: |
          Write-Host "=" * 80
          Write-Host "BUILD STAGE INFO" -ForegroundColor Cyan
          Write-Host "=" * 80
          Write-Host "Project: $(System.TeamProject)"
          Write-Host "Repository: $(Build.Repository.Name)"
          Write-Host "Branch: $(Build.SourceBranch)"
          Write-Host "Build ID: $(Build.BuildId)"
          Write-Host "Agent Name: $(Agent.Name)"
          Write-Host "Agent Pool: Default"
          Write-Host "=" * 80
          
          # Create dummy artifact
          $path = "$(Build.ArtifactStagingDirectory)\dummy"
          New-Item -ItemType Directory -Path $path -Force | Out-Null
          "test" | Out-File "$path\test.txt"
          Write-Host "✅ Dummy artifact created"
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Dummy Artifact'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/dummy'
        artifactName: 'dummy'
        publishLocation: 'Container'

# ================================
# STAGE 2: Deploy (With Deployment Job + Environment)
# ================================
- stage: Deploy
  displayName: 'Deploy Stage'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy Job'
    environment: 'VPS-Production'
    pool:
      name: 'Default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: PowerShell@2
            displayName: 'Show Deploy Info'
            inputs:
              targetType: inline
              script: |
                Write-Host "=" * 80
                Write-Host "DEPLOY STAGE RUNNING!" -ForegroundColor Green
                Write-Host "=" * 80
                Write-Host "✅ This means the environment exists and is accessible"
                Write-Host "✅ Pipeline is configured correctly"
                Write-Host "=" * 80
                Write-Host "Project: $(System.TeamProject)"
                Write-Host "Environment: VPS-Production"
                Write-Host "=" * 80

# ================================
# STAGE 3: Report
# ================================
- stage: Report
  displayName: 'Report Results'
  dependsOn:
    - Build
    - Deploy
  condition: always()
  jobs:
  - job: ReportJob
    pool:
      name: 'Default'
    steps:
    - task: PowerShell@2
      displayName: 'Show Final Status'
      inputs:
        targetType: inline
        script: |
          Write-Host "=" * 80
          Write-Host "PIPELINE RESULTS" -ForegroundColor Yellow
          Write-Host "=" * 80
          
          $buildResult = "$(stageDependencies.Build.BuildJob.result)"
          $deployResult = "$(stageDependencies.Deploy.DeployJob.result)"
          
          Write-Host "Build Stage Result: $buildResult"
          Write-Host "Deploy Stage Result: $deployResult"
          
          if ($deployResult -eq "Skipped") {
            Write-Host "`n❌ DEPLOY WAS SKIPPED" -ForegroundColor Red
            Write-Host "`nPossible reasons:" -ForegroundColor Yellow
            Write-Host "1. Environment 'VPS-Production' doesn't exist in project: $(System.TeamProject)"
            Write-Host "2. Environment requires approval and wasn't approved"
            Write-Host "3. Pipeline doesn't have permission to use environment"
            Write-Host "4. Branch protection rules are blocking deployment"
            Write-Host "`nTo check: Go to Pipelines → Environments → VPS-Production"
          } else {
            Write-Host "`n✅ DEPLOY RAN SUCCESSFULLY" -ForegroundColor Green
            Write-Host "Environment is configured correctly!"
          }
          Write-Host "=" * 80